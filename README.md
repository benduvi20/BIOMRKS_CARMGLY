# BIOMRKS_CARMGLY

-- CONTEXT:

This repo contains all published code for the training and use of RCNN networks to extract heart and lung detections and segmentations. Then the use bounding boxes and masks to calculate cardiomegaly biomarkers (CTR and CPAR) from chest x-ray samples in the MIMIC-CXR-JPG database. The biomarker values can then be used alone or in conjunction with other non-imaging data to classify multimodal cardiomegaly samples generated from linked MIMIC-IV and MIMIC-CXR data.

This repo is closely linked to 3 papers (conference, plus 2 data papers), please cite these as appropriate according to usage of code and resources:
- Multimodal Cardiomegaly Classification with Image-Derived Digital Biomarkers (https://doi.org/10.1007/978-3-031-12053-4_2)
- PhysioNet BIOMARKERS PAPER
- PhysioNet MASKS PAPER


-- AUTHORS:

This repo was authored by Benjamin Duvieusart and Felix Krones, with some scripts heavily based on code by Declan Grant. Particular acknowledgment is given to Adam Mahdi (University of Oxford, Oxford Institute) and Bartłomiej Papież (University of Oxford, Big Data Institute) for their supervision and guidance


-- USGAE NOTES:

This repo uses an assumed files structure described below and requires the download of several external databases, details and links to data which needs to be downloaded are provided in README files of the two principal subfolders. 

The 2 principal subfolders are:
- ./Biomarkers Extraction/ 
  - this folder contains all necessary instructions and scripts to load existing or train R-CNN models to extract biomarker values from all posterior-anterior chest x-ray images in the MIMIC-CXR-JGP database
- ./Cardiomegaly Classification/
  - this folder contains all necessary instructions and scripts to train XGBoost to classify cardiomegaly samples based on biomarker values (CTR and CPAR values generated by code in './Biomarker Extraction/') and other non-imaging data taken from MIMIC-IV. Alternately, it also contains all necessary instruction and scripts to train a CNN to classify cardiomegaly samples based on images from MIMIC-CXR-JPG

_Other subfolders are required in assumed file structure but are not present on repo, if folders described below are not in the repo please initialize them before running scripts to avoid running into warnings_


--- ASSUMED FILE STRUCTURE ---
  
    ***folder containing code for biomarker extraction via detection and segmentation models***
    ./Biomarker Extraction
        ***scripts to train models***
        /heart_detection.py 
        /heart_segmentation.py
        /lung_detection.py
        /lung_segmentation.py

        ***scripts to extract biomarkers (CTR and CPAR) from PA MIMIC-CXR-JPG images***
        /CPAR_full_MIMIC.py
        /CTR_full_MIMIC.py

        ***folders containing proposed training, testing, and validation sets (combination of MIMIC, JSRT, and MGMY images)***
        /heart_detection/
        /heart_segmentation/
        /lung_detection/
        /lung_segmentation/

        ***folder with python files containing engine.py (for train_one_epoch function) and utils.py function scripts from pytorch, plus empty __init__.py file***
        /support/
        
        ***save folder for biomarker values, graphs, and samples output***
        /save_folder
          /CTR/
          /CPAR/

    
    ***folder containing code for classification of cardiomegaly samples using biomarkers values and other methods***
    ./Cardiomegaly Classification
        ***Jupyter scripts for data preprocessing and training of XGBoost and CNN models for cardiomegaly classification***
        /DataPipeline.ipynb
        /Image.ipynb
        /XGBoost.ipynb

        ***empty folder which is populated by DataPipeline.ipynb to store cardiomegaly samples from MIMIC-CXR, and MIMIC-IV*** 
        /MIMIC_features/

        ***empty folder to save models and figures*** 
        /model
            /cnn/
            /xgbbost/

        ***folder with support functions for Jupyter notebooks***
        /src
            /__init__.py
            /cnn_functions.py
            /data_pipeline_functions.py
            /xcgboost_functions.py
            /utils/pandas_utils.py


    ***folder for MIMIC database containing files, images, and masks related to MIMIC-CXR, MIMIC-CXR-JPG, MIMIC_IV available on physionet.org***
    ./MIMIC 
        /cxr-record-list.csv.gz
        /mimic-cxr-2.0.0-chexpert.csv.gz
        /mimic-cxr-2.0.0-metadata.csv.gz
        /mimic-cxr-2.0.0-negbio.csv.gz
        /mimic-cxr-2.0.0-split.csv.gz
        
        /MIMIC-IV/ 
          ***hosp and icu subfolders from MIMIC-IV 2.0 database*** 
        
        /files/
            ***x-ray images in folder structure coped from MIMIC-CXR-JPG database***
            
        /masks
            /heart/
            /lungs/


    ***folders for Montgomery database containing images and masks***
    ./MGMY
        /CXR_png/
            ***folder with images from Montgomery database***
        /masks
            /heart/
            /leftMask/
            /rightMask/
            

    ***folders for JSRT database containing images and masks***
    ./JSRT
        /images/
            ***folder with all images from JSRT database***
        /masks
            /heart/
            /left_lung/
            /right_lung/
